<link rel="import" href="../jquery/dist/jquery.js">
<link rel="import" href="../iron-ajax/iron-ajax.html">
<link rel="import" href="../polymer/polymer.html">

<script src="../jstree/dist/jstree.js"></script>
<link href="../malihu-custom-scrollbar-plugin/jquery.mCustomScrollbar.min.css" rel="stylesheet" />
<script src="../malihu-custom-scrollbar-plugin/jquery.mCustomScrollbar.js"></script>

<dom-module id="poly-JsTree">
    <style>
    </style>
    <template>
        <iron-ajax auto
                   url="{{treeDataUrl}}"
                   handle-as="json"
                   on-response="_handleResponse" loading="{{isLoading}}"
                   debounce-duration="300"></iron-ajax>
        <div hidden$="{{!isLoading}}">
            <content>

            </content>
        </div>

        <div id="treeContainer">

            <div id="jsTree"></div>
        </div>
    </template>
    <script>
        Polymer({
            is: "poly-JsTree",
            properties:
                {
                    _executingPath:
                        {
                            type: String
                        },
                    theme:
                        {
                            type: String,
                            value: "default",
                            observer: "_themeChanged"
                        },
                    largeThemeVariant: {
                        type: Boolean,
                        value: false,
                        observer: "_themeVariantChanged"
                    },
                    fitToParent:
                        {
                            type: Boolean,
                            value: false,
                        },
                    scrolls:
                        {
                            type: Boolean,
                            value: false,
                        },
                    treeDataUrl:
                        {
                            type: String,
                            notify: true,
                        },
                    treeData:
                        {
                            type: Object,
                            readOnly: true,
                        },
                    isLoading:
                        {
                            type: Boolean,
                            value: false,
                        },
                    selectedNodes:
                        {
                            type: Array,
                        },
                    allowsCrud:
                    {
                        type: Boolean,
                        value: true,
                    },
                    notifyServerOfCrud:
                    {
                        type: Boolean
                    },
                    createNewNodeServerUrl:
                    {
                        type: String
                    },
                    deleteNodeServerUrl:
                    {
                        type: String
                    }
                },


            createNewChildNode: function (e) {
                var currentNode = $('#jsTree').jstree('get_selected');
                if (currentNode != null || currentNode.length > 0) {
                    var nodeid = $('#jsTree').jstree(true).create_node(currentNode[0], "new node", "first");

                    if (this.notifyServerOfCrud)
                        this.$.xhr.send({ url: this.createNewNodeServerUrl, params: { id: nodeid } });
                }
            },
            deleteSelectedNode: function (e) {
                var currentNode = $('#jsTree').jstree('get_selected');
                if (currentNode != null || currentNode.length > 0) {
                    $('#jsTree').jstree(true).delete_node(currentNode);

                    if (this.notifyServerOfCrud)
                        this.$.xhr.send({ url: this.deleteNodeServerUrl, params: { id: currentNode.Id, nodes: currentNode } });
                }
            },
            expandAllNodes: function (e) {
                $('#jsTree').jstree('open_all');
            },
            closeAllNodes: function (e) {
                $('#jsTree').jstree('close_all');
            },
            _handleResponse: function (event, request) {
                this._setTreeData(request.response);
                this._createTree();
            },
            _fitToParentSize: function () {
                this.$.jsTree.style.width = "100%";
                this.$.jsTree.style.height = "100%";

                this.$.treeContainer.style.height = this.$.treeContainer.parentElement.parentElement.style.height;
                this.$.treeContainer.style.width = this.$.treeContainer.parentElement.parentElement.style.width;
            },
            _attachScrollbars: function () {
                //$('head').append('<link rel="stylesheet" href="./bower_components/nanoscroller/bin/css/nanoscroller.css" type="text/css" />');

                this.$.treeContainer.parentElement.parentElement.style.overflow = "hidden";
                //this.$.treeContainer.clientHeight = this.$.treeContainer.parentElement.clientHeight;
                this.$.treeContainer.className += " scroller";

                if (this.theme.toLowerCase() !== "default-dark")
                    $(".scroller").mCustomScrollbar({ theme: "dark", autoExpandScrollbar: true });
                else
                    $(".scroller").mCustomScrollbar({ autoExpandScrollbar: true });
            },
            _themeChanged: function () {
                var location = this._executingPath;
                if (this.theme.toLowerCase() === "no theme") {
                    return;
                }
                if (this.theme.toLowerCase() === "default-dark") {
                    $('head').append('<link rel="stylesheet" href="' + location + '../jstree/dist/themes/default-dark/style.css" type="text/css" />');
                }
                else {
                    $('head').append('<link rel="stylesheet" href="' + location + '../jstree/dist/themes/default/style.css" type="text/css" />');
                }

            },
            _themeVariantChanged: function () {
                if ($("#jsTree").jstree(true)) {
                    if (this.largeThemeVariant)
                        $("#jsTree").jstree(true).set_theme_variant("large");
                    else
                        $("#jsTree").jstree(true).set_theme_variant(false);
                }
                else {
                    if (this.largeThemeVariant)
                        $.jstree.defaults.core.themes.variant = "large";
                }
            },
            _createTree: function () {
                var _self = this;
                $.jstree.destroy();
                $("#jsTree")
                    .on("ready.jstree", function () {
                        if (_self.fitToParent === true)
                            _self._fitToParentSize();

                        if (_self.scrolls === true)
                            _self._attachScrollbars();

                    }).on('changed.jstree', function (e, data) {
                        _self.selectedNodes = [];
                        var i, j = 0;
                        for (i = 0, j = data.selected.length; i < j; i++) {
                            _self.selectedNodes.push(data.instance.get_node(data.selected[i]));
                            console.log("selected nodes: " + _self.selectedNodes[i].text);
                        }
                            _self.fire('SelectedNodeChanged', {data:nodes});
                    })
                    .jstree({
                        'core':
                            {
                                'data': this.treeData,
                                'themes': {
                                    "name": _self.theme,
                                    "dots": true,
                                    "icons": true
                                },
                                'check_callback' :this.allowsCrud,
                            }
                    });
            },
            ready: function () {
                
                document.addEventListener("jstree.createNode", this.createNewChildNode);
                document.addEventListener("jstree.deleteNode", this.deleteSelectedNode);
                document.addEventListener("jstree.expandAll", this.expandAllNodes);
                document.addEventListener("jstree.closeAll", this.closeAllNodes);
            },
            created: function () {
                var imports = document.querySelectorAll('link[rel="import"]');
                for (var i = 0; i < imports.length; i++)
                    if (imports[i].href.toLowerCase().indexOf("poly-jstree") > 0)
                        this._executingPath = imports[i].href.toLowerCase().substring(0, imports[i].href.lastIndexOf('/') + 1)
            }

        });
    </script>
</dom-module>
